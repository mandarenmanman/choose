<html>

<head>
    <meta charset="UTF-8" />
    <title>防疫政策意向投票-基于以太坊</title>
    <link rel="icon" type="image/svg" href="https://metamask.github.io/test-dapp/metamask-fox.svg" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.1/css/mdb.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://metamask.github.io/test-dapp/index.css" type="text/css" />
    <style type="text/css">
    section {
        margin: 1px 0 0px 0;
    }
    </style>
</head>

<body>
    <main class="container-fluid">
        <header>
            <div id="logo-container">
                <h2 id="logo-text" class="text-center">
                    防疫政策意向投票-基于区块链-以太坊Goerli 测试网络
                </h2>
            </div>
        </header>
        <section>
            <div id="warning" class="row justify-content-center error-div">
                <div class="error-message justify-content-center col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                    <img src="alert-red.svg" alt="" class="error-message-icon
              " />
                    <div class="error-message-text">请使用以太坊Goerli 测试网络.仅支持Microsoft Edge浏览器</div>
                </div>
            </div>
            <div class="row">
                <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                    <p class="info-text alert alert-primary">
                        中立: <span id="neutrality">链接钱包获取</span>
                    </p>
                </div>
                <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                    <p class="info-text alert alert-secondary">
                        开放: <span id="open">链接钱包获取</span>
                    </p>
                </div>
                <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                    <p class="info-text alert alert-success">
                        动态清零: <span id="dynamicZeroing">链接钱包获取</span>
                    </p>
                </div>
            </div>
        </section>
        <section>
            <div class="row">
                <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12 d-flex align-items-stretch">
                    <div class="card full-width">
                        <div class="card-body">
                            <button class="btn btn-primary btn-lg btn-block mb-3" id="Connect">
                                链接MetaMask
                            </button>
                            <p class="info-text alert alert-success">
                                你的地址: <span id="clientAccounts">未链接账户</span>
                            </p>
                            <hr />
                            <div class="form-group">
                                <label>邀请你的账户地址</label>
                                <input class="form-control" type="text" id="higher" value="" placeholder="0x......" />
                            </div>
                            <button class="btn btn-primary btn-lg btn-block mb-3" id="bind">
                                绑定
                            </button>
                            <p class="info-text alert alert-success">
                                邀请你的账户地址: <span id="higherText"></span>
                            </p>
                            <div class="form-group">
                                <label>好友的地址</label>
                                <input class="form-control" type="text" id="inviteAdr" placeholder="0x......" />
                            </div>
                            <button class="btn btn-primary btn-lg btn-block mb-3" id="invite">
                                邀请好友投票
                            </button>
                            <div id="peopleAddr">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12 d-flex align-items-stretch">
                    <div class="card full-width">
                        <div class="card-body">
                            <h4 class="card-title">
                                投票
                            </h4>
                            <p class="info-text alert alert-success">
                                你的投票结果: <span id="getMyVotingMsg"></span>
                            </p>
                            <button class="btn btn-outline-secondary btn-lg btn-block mb-3 _choose" data-choose="3">
                                中立
                            </button>
                            <button class="btn btn-outline-secondary btn-lg btn-block mb-3 _choose" data-choose="2">
                                开放
                            </button>
                            <button class="btn btn-outline-secondary btn-lg btn-block mb-3 _choose" data-choose="1">
                                动态清零
                            </button>
                            <hr />
                            <div class="form-group">
                                <label>查询对应地址投票结果</label>
                                <input class="form-control" type="text" placeholder="0x......" id="getVotingAddr" />
                            </div>
                            <button class="btn btn-primary btn-lg btn-block mb-3" id="getVotingId">
                                查询
                            </button>
                            <p class="info-text alert alert-success">
                                地址对应投票结果: <span id="getVotingMsg"></span>
                            </p>
                            <div class="form-group">
                                <label>查询地址邀请的好友</label>
                                <input class="form-control" type="text" id="otherPeopleAddr" placeholder="0x......" />
                            </div>
                            <button class="btn btn-primary btn-lg btn-block mb-3" id="otherPeople">
                                查询地址邀请的好友
                            </button>
                            <div id="otherPeopleAddrList">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12 d-flex align-items-stretch">
                    <div class="card full-width">
                        <div class="card-body">
                            <h4 class="card-title">
                                投票说明
                            </h4>
                            <div class="form-group">
                                <label style="color: red">
                                    首先我们需要寻求一个共识，中立，动态清零，开放，并将这些人联系起来<br />
                                    中立：是否有更好的方法<br />
                                    开放：是否接受开放的代价,谁来负责,如何开放,谁来执行<br />
                                    动态清零：是否接受动态清零的代价,谁来负责,如何动态清零,谁来执行<br />
                                    建议大家积极参与监督人大代表选举投票
                                </label>
                            </div>
                            <h4 class="card-title">
                                规则说明
                            </h4>
                            <div class="form-group">
                                <label>
                                    由合约创建人初始化,基于六度关系理论,每位被邀请人可邀请六人投票<br />
                                    每人可投一票<br />
                                    请邀请你信任的人投票,这将影响你对投票结果的信任<br />
                                    程序问题请联系66ccff@historyblock.org<br />
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary btn-lg btn-block mb-3" id="mintButton" onclick="window.open('https://github.com/mandarenmanman/choose')">
                                    合约开源地址
                                </button>
                                <button class="btn btn-primary btn-lg btn-block mb-3" id="mintButton" onclick="window.open('https://goerli.etherscan.io/address/0xa15d02b6a8178be889dee018575f38e340072a9b')">
                                    合约部署地址
                                </button>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary btn-lg btn-block mb-3" id="mintButton">
                                    投票教程(暂无)
                                </button>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary btn-lg btn-block mb-3" id="mintButton" onclick="window.open('https://goerlifaucet.com/')">
                                    以太坊Goerli 测试网络水龙头
                                </button>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary btn-lg btn-block mb-3" id="mintButton" onclick="window.open('https://metamask.io/')">
                                    MetaMask账户注册说明
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <div id="anchor" style="visibility:hidden">by mandaren</div>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    var chooseAbi = [
        //邀请
        "function invite(address invited, address higher) public returns (uint256)",

        //投票
        "function voting(uint256 choose, address higher) public returns (uint256)",

        //获取地址对应投票结果
        "function getVoting(address adr) public view returns (uint256)",

        //获取邀请的地址
        "function getPeople(address adr) public view returns (address[] memory _array)",

        //获取当前账户是否在邀请名单中
        "function whitelistCheck(address higher) public returns (bool)",

        //获取中立投票数
        "function neutrality() public view returns (uint256)",

        //获取开放投票数
        "function open() public view returns (uint256)",

        //获取动态清零投票数
        "function dynamicZeroing() public view returns (uint256)",

        //白名单查询事件
        "event whitelistCheckEvent(address indexed higher,address indexed owner,bool wCheck)",

        //邀请结果返回
        "event inviteEvent(address indexed owner,address indexed higher,uint256 calltag)" //calltag //1 邀请用户成功  2 你的邀请人不在白名单中  3 已达到最大邀请人
    ];

    var ethClient;
    var clientAccounts;
    var chooseContractClient;
    const chooseAddress = "0xA15D02b6A8178be889DEe018575f38e340072A9B"; //合约地址
    var signerClient;
    const ownerAddress = "0x83872CE33905776EF9e159b892AC0Ad568bA388F"; //合约部署账户

    function rollBottom() {

        document.querySelector('#anchor').scrollIntoView(true);
        document.querySelector('#anchor').scrollIntoView(true);
    }


    //查询对应地址邀请的好友
    $("#otherPeople").click(
        function() {
            if (!isConnect()) {
                return;
            }
            otherPeople();
        })
    async function otherPeople() {

        const otherPeopleAddr = $("#otherPeopleAddr").val();
        console.log("otherPeopleAddr:" + otherPeopleAddr);

        if (otherPeopleAddr.length != 42) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: '请先输入你要查询的账户地址!',
            })
            return;
        }

        getPeopleAsync(otherPeopleAddr, "#otherPeopleAddrList");

        rollBottom();

    }


    //投票
    $("._choose").click(
        function() {
            if (!isConnect()) {
                return;
            }
            choose(this);
        })
    async function choose(that) {


        const chooseV = that.getAttribute("data-choose");
        console.log("chooseV:" + chooseV); //122

        contract = new ethers.Contract(chooseAddress, chooseAbi, signerClient)

        let higherText = $("#higherText").html();

        const owner = $("#clientAccounts").html();

        console.log("owner:" + owner);
        console.log("ownerAddress:" + ownerAddress);

        if (owner.toUpperCase() != ownerAddress.toUpperCase()) {
            if (higherText.length != 42) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: '请先绑定邀请你的账户地址!',
                })
                return;
            }
        } else {
            higherText = ownerAddress;
        }


        const getMyVotingMsg = $("#getMyVotingMsg").html();
        if (getMyVotingMsg == "" || getMyVotingMsg == "未投票") {

            tx = await contract.voting(chooseV, higherText)
            Swal.fire(
                '你的投票是：' + getVinfo(chooseV) + '!',
                '投票成功',
                'success'
            )
            $("#getMyVotingMsg").html(getVinfo(chooseV))
            //将投票结果展示出来

        } else {

            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: '每人只能投票一次!',
            })


        }



    }

    //查询投票结果
    $("#getVotingId").click(
        function() {
            if (!isConnect()) {
                return;
            }
            getVoting();
        })
    async function getVoting() {

        const getVotingAddr = $("#getVotingAddr").val();
        console.log("getVotingAddr:" + getVotingAddr);

        if (getVotingAddr.length != 42) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: '请先输入你要查询的账户地址!',
            })
            return;
        }

        getV(getVotingAddr, "#getVotingMsg");

    }


    //邀请好友
    $("#invite").click(
        function() {
            if (!isConnect()) {
                return;
            }
            invite();
        })
    async function invite() {


        contract = new ethers.Contract(chooseAddress, chooseAbi, signerClient)

        let higherText = $("#higherText").html();

        const owner = $("#clientAccounts").html();

        console.log("owner:" + owner);
        console.log("ownerAddress:" + ownerAddress);

        if (owner.toUpperCase() != ownerAddress.toUpperCase()) {
            if (higherText.length != 42) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: '请绑定邀请你的账户地址!',
                })
                return;
            }
        } else {
            higherText = ownerAddress;
        }


        console.log("higherText:" + higherText);
        const inviteAdr = $("#inviteAdr").val();
        console.log("inviteAdr:" + inviteAdr);

        if (inviteAdr.length != 42) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: '请先输入你要邀请的账户地址!',
            })
            return;
        }

        //邀请好友投票
        tx = await contract.invite(inviteAdr, higherText)


        //获取事件
        let filter = contract.filters.inviteEvent(owner, null)
        contract.on(filter, (sender, higher, calltag, event) => {
            console.log('--- the Ower ----')
            console.log('higher=', higher)
            console.log('sender=', sender)





            console.log(event);

            const tag = ethers.BigNumber.from(calltag).toNumber();
            console.log('calltag=', tag)

            if (tag == 1) {
                Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: '邀请账户成功!',
                    showConfirmButton: false,
                    timer: 1500
                })
                getPeopleAsync();
            } else if (tag == 2) {
                Swal.fire({
                    position: 'top-end',
                    icon: 'error',
                    title: '你的邀请人不在白名单中!',
                    showConfirmButton: false,
                    timer: 1500
                })
            } else {
                Swal.fire({
                    position: 'top-end',
                    icon: 'error',
                    title: '邀请的用户最多6个!',
                    showConfirmButton: false,
                    timer: 1500
                })
            }
            console.log('eventNumber=', event.blockNumber)
        })

    }

    //白名单确认
    $("#bind").click(
        function() {
            if (!isConnect()) {
                return;
            }
            bind();
        })
    async function bind() {


        contract = new ethers.Contract(chooseAddress, chooseAbi, signerClient)



        const higher = $("#higher").val();
        console.log("higher:" + higher);
        if (higher.length != 42) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: '请先输入邀请你的账户地址!',
            })
            return;
        }

        tx = await contract.whitelistCheck(higher)

        console.log(tx)

        const owner = $("#clientAccounts").html();

        let filter = contract.filters.whitelistCheckEvent(null, owner)
        contract.on(filter, (higher, sender, wCheck, event) => {
            console.log('--- the Ower ----')
            console.log('higher=', higher)
            console.log('sender=', sender)
            console.log('wCheck=', wCheck)

            //由于白名单绑定方法会被多个方法调用会多次触发事件,排除被其他方法调用而触发的事件
            if ($("#higherText").html() != higher) {
                if (!wCheck) {
                    $("#higherText").html(":该账户未邀请你,或者联系66ccff@historyblock.org,事件ID:" + event.blockNumber);
                } else {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: '绑定账户成功',
                        showConfirmButton: false,
                        timer: 1500
                    })
                    $("#higherText").html(higher);
                }
                console.log('eventNumber=', event.blockNumber)
            }


        })


    }

    //链接账户
    $("#Connect").click(
        function() {
            connect();
        })

    //链接账户异步方法
    async function connect() {
        const provider = new ethers.providers.Web3Provider(window.ethereum);

        const signer = provider.getSigner();

        signerClient = signer;

        const chooseContract = new ethers.Contract(chooseAddress, chooseAbi, provider);
        const accounts = await provider.send("eth_requestAccounts", []);
        ethClient = provider;
        chooseContractClient = chooseContract;
        clientAccounts = accounts;
        $("#clientAccounts").html(clientAccounts[0]);




        //每疫苗刷新一次投票结果
        getAllVoting();
        setIntervalRun();

        getV(clientAccounts[0], "#getMyVotingMsg");
        getPeopleAsync(clientAccounts[0], "#peopleAddr");

    }
    async function sleep(ms = 5000) {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }
    async function setIntervalRun() {
        while (true) {
            await sleep();
            await getAllVoting();
        }
    }




    //判断当前账户是否链接
    function isConnect() {
        const owner = $("#clientAccounts").html();

        console.log("owner:" + owner);

        if (owner.length != 42) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: '请链接MetaMask!',
            })
            return false;
        }

        return true;

    }

    //查询地址对应投票结果
    async function getV(getVotingAddr, msgId) {
        /**

        if (choose == 1) {
            dynamicZeroing = dynamicZeroing + 1; //0 动态清零
            return dynamicZeroing;
        } else if (choose == 2) {
            open = open + 1; //开放
            return open;
        } else if (choose == 3) {
            neutrality = neutrality + 1; //中立
            return neutrality;
        }

        */
        const voting = await chooseContractClient.getVoting(getVotingAddr);
        console.log("voting:" + voting);

        $(msgId).html(getVinfo(voting));
    }


    //投票结果转换,前端页面可能被篡改,安全的方式应该是查看合约查询对应的值
    function getVinfo(voting) {

        /**

        if (choose == 1) {
            dynamicZeroing = dynamicZeroing + 1; //0 动态清零
            return dynamicZeroing;
        } else if (choose == 2) {
            open = open + 1; //开放
            return open;
        } else if (choose == 3) {
            neutrality = neutrality + 1; //中立
            return neutrality;
        }

        */

        if (voting == 3) {
            return "中立";
        } else if (voting == 1) {
            return "动态清零";
        } else if (voting == 2) {
            return "开放";
        } else {
            return "未投票";
        }

    }

    //查询全部投票信息
    async function getAllVoting() {
        //获取中立投票数
        const neutrality = await chooseContractClient.neutrality();
        console.log("neutrality:" + neutrality);
        $("#neutrality").html(neutrality + "");

        //获取开放投票数
        const open = await chooseContractClient.open();
        console.log("open:" + open);
        $("#open").html(open + "");

        //获取动态清零投票数
        const dynamicZeroing = await chooseContractClient.dynamicZeroing();
        console.log("dynamicZeroing:" + dynamicZeroing);
        $("#dynamicZeroing").html(dynamicZeroing + "");
    }

    //查询我邀请的好友
    async function getPeopleAsync(addr, viewId) {

        const getPeople = await chooseContractClient.getPeople(addr);
        console.log("getPeople:" + getPeople.length);



        var peopleText = "<label>邀请的好友地址</label>";

        if (getPeople.length == 0) {

            peopleText += '<p class="info-text alert alert-success">未邀请好友</span>  </p>';
            console.log(peopleText);
            $(viewId).html(peopleText);
            return;

        }

        for (i = 0; i < getPeople.length; i++) {
            peopleText += '<p class="info-text alert alert-success">  好友地址' + (i + 1) + ': <span>' + getPeople[i] + '</span>  </p>';
        }

        console.log(peopleText);
        $(viewId).html(peopleText);

    }
    </script>
</body>

</html>
